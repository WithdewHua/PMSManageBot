<template>
  <div class="admin-panel">
    <v-container fluid class="px-2 px-sm-4">
      <v-row>
        <v-col cols="12">
          <h1 class="text-h5 text-sm-h4 mb-4 mb-sm-6">ğŸ° è½¬ç›˜ç®¡ç†é¢æ¿</h1>
        </v-col>
      </v-row>

      <!-- å¿«é€Ÿæ“ä½œå¡ç‰‡ -->
      <v-row>
        <v-col cols="6" sm="6" md="6" lg="3">
          <v-card class="admin-card" elevation="6" rounded="xl">
            <v-card-title class="d-flex align-center pa-3 pa-sm-4 admin-card-header">
              <v-avatar size="32" class="mr-2" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="18" color="white">mdi-cog</v-icon>
              </v-avatar>
              <span class="text-body-2 text-sm-body-1 font-weight-bold">è½¬ç›˜é…ç½®</span>
            </v-card-title>
            <v-card-text class="pa-3 pa-sm-4">
              <div class="text-caption text-sm-body-2 text-medium-emphasis">ç®¡ç†å¥–å“è®¾ç½®ã€æ¦‚ç‡åˆ†é…å’Œå‚ä¸æ¡ä»¶</div>
            </v-card-text>
            <v-card-actions class="pa-3 pa-sm-4 pt-0">
              <v-btn color="primary" block size="small" variant="elevated" @click="openWheelConfig">
                <v-icon size="16" class="mr-1">mdi-cog</v-icon>
                é…ç½®è½¬ç›˜
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-col>

        <v-col cols="6" sm="6" md="6" lg="3">
          <v-card class="admin-card" elevation="6" rounded="xl">
            <v-card-title class="d-flex align-center pa-3 pa-sm-4 admin-card-header">
              <v-avatar size="32" class="mr-2" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="18" color="white">mdi-chart-line</v-icon>
              </v-avatar>
              <span class="text-body-2 text-sm-body-1 font-weight-bold">éšæœºæ€§æµ‹è¯•</span>
            </v-card-title>
            <v-card-text class="pa-3 pa-sm-4">
              <div class="text-caption text-sm-body-2 text-medium-emphasis">éªŒè¯æŠ½å¥–ç®—æ³•çš„å…¬å¹³æ€§å’Œéšæœºæ€§åˆ†å¸ƒ</div>
            </v-card-text>
            <v-card-actions class="pa-3 pa-sm-4 pt-0">
              <v-btn color="success" block size="small" variant="elevated" @click="openRandomnessTest">
                <v-icon size="16" class="mr-1">mdi-play</v-icon>
                è¿è¡Œæµ‹è¯•
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-col>

        <v-col cols="6" sm="6" md="6" lg="3">
          <v-card class="admin-card" elevation="6" rounded="xl">
            <v-card-title class="d-flex align-center pa-3 pa-sm-4 admin-card-header">
              <v-avatar size="32" class="mr-2" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="18" color="white">mdi-tune</v-icon>
              </v-avatar>
              <span class="text-body-2 text-sm-body-1 font-weight-bold">ç®—æ³•é…ç½®</span>
            </v-card-title>
            <v-card-text class="pa-3 pa-sm-4">
              <div class="text-caption text-sm-body-2 text-medium-emphasis">è°ƒæ•´éšæœºæ€§å‚æ•°å’Œä¿æŠ¤æœºåˆ¶è®¾ç½®</div>
            </v-card-text>
            <v-card-actions class="pa-3 pa-sm-4 pt-0">
              <v-btn color="warning" block size="small" variant="elevated" @click="openRandomnessConfig">
                <v-icon size="16" class="mr-1">mdi-tune</v-icon>
                ç®—æ³•é…ç½®
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-col>

        <v-col cols="6" sm="6" md="6" lg="3">
          <v-card class="admin-card" elevation="6" rounded="xl">
            <v-card-title class="d-flex align-center pa-3 pa-sm-4 admin-card-header">
              <v-avatar size="32" class="mr-2" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="18" color="white">mdi-chart-bar</v-icon>
              </v-avatar>
              <span class="text-body-2 text-sm-body-1 font-weight-bold">ä½¿ç”¨ç»Ÿè®¡</span>
            </v-card-title>
            <v-card-text class="pa-3 pa-sm-4">
              <div class="text-caption text-sm-body-2 text-medium-emphasis">æŸ¥çœ‹è½¬ç›˜ä½¿ç”¨æƒ…å†µå’Œç”¨æˆ·å‚ä¸æ•°æ®</div>
            </v-card-text>
            <v-card-actions class="pa-3 pa-sm-4 pt-0">
              <v-btn color="info" block size="small" variant="elevated" @click="viewStats">
                <v-icon size="16" class="mr-1">mdi-chart-bar</v-icon>
                æŸ¥çœ‹ç»Ÿè®¡
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-col>
      </v-row>

      <!-- è½¬ç›˜é¢„è§ˆ -->
      <v-row class="mt-4 mt-sm-6">
        <v-col cols="12">
          <v-card elevation="10" rounded="xl" class="preview-card">
            <v-card-title class="d-flex align-center pa-4 pa-sm-6 preview-card-header">
              <v-avatar size="40" class="mr-3" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="24" color="white">mdi-ferris-wheel</v-icon>
              </v-avatar>
              <span class="text-body-1 text-sm-h6 font-weight-bold">è½¬ç›˜é¢„è§ˆ</span>
            </v-card-title>
            
            <v-card-text class="pa-4 pa-sm-6">
              <div class="wheel-preview-container">
                <div class="wheel-wrapper">
                  <LuckyWheel 
                    ref="luckyWheel"
                    :disabled="true"
                    @spin-complete="onSpinComplete" 
                    @result-closed="onResultClosed"
                  />
                </div>
              </div>
            </v-card-text>
          </v-card>
        </v-col>
      </v-row>

      <!-- å½“å‰éšæœºæ€§é…ç½® -->
      <v-row class="mt-4 mt-sm-6">
        <v-col cols="12">
          <v-card elevation="8" rounded="xl" class="config-card">
            <v-card-title class="d-flex align-center flex-wrap pa-4 pa-sm-6 config-card-header">
              <v-avatar size="36" class="mr-3" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="20" color="white">mdi-tune</v-icon>
              </v-avatar>
              <span class="text-body-1 text-sm-h6 mr-2 font-weight-bold">å½“å‰éšæœºæ€§é…ç½®</span>
              <v-spacer class="d-none d-sm-flex"></v-spacer>
              <v-btn
                color="white"
                variant="outlined"
                size="small"
                prepend-icon="mdi-cog"
                @click="openRandomnessConfig"
                class="mt-2 mt-sm-0 config-btn"
              >
                ä¿®æ”¹é…ç½®
              </v-btn>
            </v-card-title>
            
            <v-card-text class="pa-4 pa-sm-6">
              <v-row>
                <v-col cols="12" sm="6" md="3">
                  <div class="config-item">
                    <div class="config-label">ä½æ¦‚ç‡ä¿æŠ¤</div>
                    <div class="config-value">
                      <v-chip 
                        :color="randomnessConfig.use_weighted_protection ? 'success' : 'default'"
                        variant="flat"
                        size="small"
                        rounded="lg"
                        class="config-chip"
                      >
                        {{ randomnessConfig.use_weighted_protection ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                      </v-chip>
                    </div>
                  </div>
                </v-col>
                <v-col cols="12" sm="6" md="3" v-if="randomnessConfig.use_weighted_protection">
                  <div class="config-item">
                    <div class="config-label">ä¿æŠ¤é˜ˆå€¼</div>
                    <div class="config-value config-number">{{ randomnessConfig.protection_threshold || 0 }}%</div>
                  </div>
                </v-col>
                <v-col cols="12" sm="6" md="3" v-if="randomnessConfig.use_weighted_protection">
                  <div class="config-item">
                    <div class="config-label">ä¿æŠ¤ç³»æ•°</div>
                    <div class="config-value config-number">{{ randomnessConfig.protection_factor || 1.0 }}</div>
                  </div>
                </v-col>
                <v-col cols="12" sm="6" md="3">
                  <div class="config-item">
                    <div class="config-label">æ—¶é—´ç†µæ··åˆ</div>
                    <div class="config-value">
                      <v-chip 
                        :color="randomnessConfig.use_time_seed_mixing ? 'success' : 'default'"
                        variant="flat"
                        size="small"
                        rounded="lg"
                        class="config-chip"
                      >
                        {{ randomnessConfig.use_time_seed_mixing ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                      </v-chip>
                    </div>
                  </div>
                </v-col>
                <v-col cols="12" sm="6" md="3">
                  <div class="config-item">
                    <div class="config-label">ç”¨æˆ·IDç†µæ··åˆ</div>
                    <div class="config-value">
                      <v-chip 
                        :color="randomnessConfig.use_user_seed_mixing ? 'success' : 'default'"
                        variant="flat"
                        size="small"
                        rounded="lg"
                        class="config-chip"
                      >
                        {{ randomnessConfig.use_user_seed_mixing ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                      </v-chip>
                    </div>
                  </div>
                </v-col>
              </v-row>
            </v-card-text>
          </v-card>
        </v-col>
      </v-row>

      <!-- æœ€è¿‘æµ‹è¯•ç»“æœ -->
      <v-row class="mt-4 mt-sm-6" v-if="lastTestResult">
        <v-col cols="12">
          <v-card elevation="8" rounded="xl" class="result-card">
            <v-card-title class="d-flex align-center flex-wrap pa-4 pa-sm-6 result-card-header">
              <v-avatar size="36" class="mr-3" color="rgba(255,255,255,0.2)" variant="flat">
                <v-icon size="20" color="white">mdi-history</v-icon>
              </v-avatar>
              <span class="text-body-1 text-sm-h6 mr-2 font-weight-bold">æœ€è¿‘æµ‹è¯•ç»“æœ</span>
              <v-spacer class="d-none d-sm-flex"></v-spacer>
              <v-chip 
                :color="lastTestResult.overall_fairness ? 'success' : 'error'"
                variant="flat"
                size="small"
                class="mt-2 mt-sm-0 result-chip"
              >
                {{ lastTestResult.overall_fairness ? 'å…¬å¹³' : 'éœ€è¦è°ƒæ•´' }}
              </v-chip>
            </v-card-title>
            
            <v-card-text class="pa-4 pa-sm-6">
              <v-row class="test-result-row">
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-primary">{{ lastTestResult.iterations?.toLocaleString() }}</div>
                      <div class="text-caption text-medium-emphasis">æµ‹è¯•æ¬¡æ•°</div>
                    </v-card-text>
                  </v-card>
                </v-col>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-success">{{ lastTestResult.valid_items }}</div>
                      <div class="text-caption text-medium-emphasis">æœ‰æ•ˆå¥–å“</div>
                    </v-card-text>
                  </v-card>
                </v-col>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-warning">{{ lastTestResult.average_deviation }}%</div>
                      <div class="text-caption text-medium-emphasis">å¹³å‡åå·®</div>
                    </v-card-text>
                  </v-card>
                </v-col>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-info">{{ formatDate(lastTestResult.timestamp) }}</div>
                      <div class="text-caption text-medium-emphasis">æµ‹è¯•æ—¶é—´</div>
                    </v-card-text>
                  </v-card>
                </v-col>
              </v-row>
            </v-card-text>
          </v-card>
        </v-col>
      </v-row>
    </v-container>

    <!-- éšæœºæ€§æµ‹è¯•å¼¹çª— -->
    <v-dialog 
      v-model="showTestDialog" 
      :max-width="$vuetify.display.xs ? '95vw' : '800'"
      :fullscreen="$vuetify.display.xs"
    >
      <v-card rounded="xl" elevation="12" class="dialog-card">
        <v-card-title class="text-body-1 text-sm-h6 pa-4 pa-sm-6 dialog-header">
          <v-avatar size="32" class="mr-3" color="success" variant="flat">
            <v-icon size="18" color="white">mdi-chart-line</v-icon>
          </v-avatar>
          <span class="font-weight-bold">å¿«é€Ÿéšæœºæ€§æµ‹è¯•</span>
        </v-card-title>
        <v-card-text class="pa-4 pa-sm-6">
          <!-- æµ‹è¯•é…ç½® -->
          <v-row class="mb-4">
            <v-col cols="12" sm="6">
              <v-text-field
                v-model.number="testIterations"
                label="æµ‹è¯•æ¬¡æ•°"
                type="number"
                min="1000"
                max="100000"
                step="1000"
                density="compact"
                variant="outlined"
                rounded="lg"
                hint="å»ºè®® 10000-50000 æ¬¡"
              ></v-text-field>
            </v-col>
            <v-col cols="12" sm="6" class="d-flex align-center">
              <v-btn
                @click="runRandomnessTest"
                color="primary"
                :loading="testRunning"
                :disabled="testRunning"
                block
                size="small"
                variant="elevated"
              >
                <v-icon class="mr-2">mdi-play</v-icon>
                å¼€å§‹æµ‹è¯•
              </v-btn>
            </v-col>
          </v-row>

          <!-- åŠ è½½çŠ¶æ€ -->
          <div v-if="testRunning" class="text-center py-8">
            <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
            <div class="mt-4 text-body-1">æ­£åœ¨è¿è¡Œéšæœºæ€§æµ‹è¯•...</div>
          </div>

          <!-- æµ‹è¯•ç»“æœ -->
          <div v-if="currentTestResult">
            <v-divider class="mb-6"></v-divider>
            
            <!-- æµ‹è¯•æ¦‚è§ˆ -->
            <div class="mb-6">
              <h4 class="mb-4 text-body-1 text-sm-h6 font-weight-bold">æµ‹è¯•æ¦‚è§ˆ</h4>
              <v-row>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-primary">{{ currentTestResult.iterations?.toLocaleString() }}</div>
                      <div class="text-caption text-medium-emphasis">æµ‹è¯•æ¬¡æ•°</div>
                    </v-card-text>
                  </v-card>
                </v-col>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-success">{{ currentTestResult.valid_items }}</div>
                      <div class="text-caption text-medium-emphasis">æœ‰æ•ˆå¥–å“</div>
                    </v-card-text>
                  </v-card>
                </v-col>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold" :class="currentTestResult.overall_fairness ? 'text-success' : 'text-error'">
                        {{ currentTestResult.overall_fairness ? 'å…¬å¹³' : 'å¼‚å¸¸' }}
                      </div>
                      <div class="text-caption text-medium-emphasis">æ•´ä½“è¯„ä¼°</div>
                    </v-card-text>
                  </v-card>
                </v-col>
                <v-col cols="6" sm="3">
                  <v-card variant="outlined" class="text-center stat-card" elevation="3">
                    <v-card-text class="pa-3">
                      <div class="text-body-1 text-sm-h6 font-weight-bold text-warning">{{ currentTestResult.average_deviation }}%</div>
                      <div class="text-caption text-medium-emphasis">å¹³å‡åå·®</div>
                    </v-card-text>
                  </v-card>
                </v-col>
              </v-row>
            </div>

            <!-- è¯¦ç»†æµ‹è¯•ç»“æœ -->
            <div v-if="currentTestResult.stats && currentTestResult.stats.length > 0" class="mb-4">
              <h4 class="mb-4 text-body-1 text-sm-h6 font-weight-bold d-flex align-center">
                <v-icon class="mr-2" color="primary">mdi-chart-bar</v-icon>
                å„å¥–å“æµ‹è¯•è¯¦æƒ…
              </h4>
              
              <v-row>
                <v-col 
                  v-for="(stat, index) in currentTestResult.stats" 
                  :key="index"
                  cols="12" 
                  sm="6" 
                  md="4"
                  lg="3"
                >
                  <v-card 
                    variant="outlined" 
                    class="item-stat-card"
                    elevation="4"
                    rounded="lg"
                    :class="getStatCardClass(stat)"
                  >
                    <v-card-text class="pa-4">
                      <!-- å¥–å“æ ‡é¢˜ -->
                      <div class="d-flex align-center mb-3">
                        <v-avatar 
                          size="24" 
                          :color="getItemColor(index)"
                          variant="flat"
                          class="mr-2"
                        >
                          <span class="text-white text-caption font-weight-bold">{{ index + 1 }}</span>
                        </v-avatar>
                        <div class="flex-grow-1">
                          <div class="text-subtitle-2 font-weight-bold text-truncate">
                            {{ stat.name || `å¥–å“ ${index + 1}` }}
                          </div>
                        </div>
                        <v-chip 
                          :color="getDeviationColor(stat.deviation)"
                          variant="flat"
                          size="x-small"
                          rounded="lg"
                        >
                          {{ stat.deviation > 0 ? '+' : '' }}{{ stat.deviation }}%
                        </v-chip>
                      </div>
                      
                      <!-- æ¦‚ç‡å¯¹æ¯” -->
                      <div class="mb-3">
                        <div class="d-flex justify-space-between text-caption text-medium-emphasis mb-1">
                          <span>æœŸæœ›æ¦‚ç‡</span>
                          <span>{{ stat.expected_probability }}%</span>
                        </div>
                        <div class="d-flex justify-space-between text-caption mb-2">
                          <span class="font-weight-bold">å®é™…æ¦‚ç‡</span>
                          <span class="font-weight-bold">{{ stat.actual_probability }}%</span>
                        </div>
                        
                        <!-- æ¦‚ç‡å¯è§†åŒ–æ¡ -->
                        <div class="probability-comparison">
                          <!-- æœŸæœ›æ¦‚ç‡æ¡ -->
                          <div class="mb-1">
                            <v-progress-linear
                              :model-value="stat.expected_probability"
                              height="4"
                              rounded
                              color="grey-lighten-1"
                              bg-color="grey-lighten-4"
                            ></v-progress-linear>
                            <div class="text-caption text-grey text-center mt-1">æœŸæœ›</div>
                          </div>
                          
                          <!-- å®é™…æ¦‚ç‡æ¡ -->
                          <div>
                            <v-progress-linear
                              :model-value="stat.actual_probability"
                              height="6"
                              rounded
                              :color="getDeviationColor(stat.deviation)"
                              :bg-color="getDeviationColor(stat.deviation) + '-lighten-4'"
                            ></v-progress-linear>
                            <div class="text-caption text-center mt-1" :class="'text-' + getDeviationColor(stat.deviation)">
                              å®é™…
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- ç»Ÿè®¡æ•°æ® -->
                      <v-divider class="mb-2"></v-divider>
                      <div class="d-flex justify-space-between">
                        <div class="text-center">
                          <div class="text-body-2 font-weight-bold text-primary">{{ stat.count?.toLocaleString() }}</div>
                          <div class="text-caption text-medium-emphasis">ä¸­å¥–æ¬¡æ•°</div>
                        </div>
                        <div class="text-center">
                          <div class="text-body-2 font-weight-bold" :class="'text-' + getDeviationColor(stat.deviation)">
                            {{ Math.abs(stat.deviation) }}%
                          </div>
                          <div class="text-caption text-medium-emphasis">åå·®å¹…åº¦</div>
                        </div>
                        <div class="text-center">
                          <v-icon 
                            :color="getFairnessColor(stat.is_fair)"
                            size="16"
                          >
                            {{ stat.is_fair ? 'mdi-check-circle' : 'mdi-alert-circle' }}
                          </v-icon>
                          <div class="text-caption text-medium-emphasis">
                            {{ stat.is_fair ? 'æ­£å¸¸' : 'å¼‚å¸¸' }}
                          </div>
                        </div>
                      </div>
                    </v-card-text>
                  </v-card>
                </v-col>
              </v-row>
            </div>

            <!-- æµ‹è¯•åˆ†æå»ºè®® -->
            <div v-if="testAnalysis" class="mb-4">
              <v-alert
                :type="testAnalysis.type"
                variant="tonal"
                rounded="lg"
                class="test-analysis-alert"
              >
                <template v-slot:prepend>
                  <v-icon size="large">{{ testAnalysis.icon }}</v-icon>
                </template>
                <div class="text-subtitle-1 font-weight-bold mb-1">{{ testAnalysis.title }}</div>
                <div class="text-body-2">{{ testAnalysis.message }}</div>
                <div v-if="testAnalysis.suggestions && testAnalysis.suggestions.length > 0" class="mt-2">
                  <div class="text-subtitle-2 font-weight-bold mb-1">å»ºè®®ï¼š</div>
                  <ul class="text-body-2">
                    <li v-for="(suggestion, index) in testAnalysis.suggestions" :key="index">
                      {{ suggestion }}
                    </li>
                  </ul>
                </div>
              </v-alert>
            </div>
          </div>
        </v-card-text>
        <v-card-actions class="pa-4 pa-sm-6">
          <v-spacer></v-spacer>
          <v-btn size="small" variant="text" @click="showTestDialog = false">å…³é—­</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- éšæœºæ€§é…ç½®å¼¹çª— -->
    <v-dialog 
      v-model="showConfigDialog" 
      :max-width="$vuetify.display.xs ? '95vw' : '600'"
      :fullscreen="$vuetify.display.xs"
    >
      <v-card rounded="xl" elevation="12" class="dialog-card">
        <v-card-title class="d-flex align-center pa-4 pa-sm-6 dialog-header">
          <v-avatar size="32" class="mr-3" color="teal" variant="flat">
            <v-icon size="18" color="white">mdi-tune</v-icon>
          </v-avatar>
          <span class="text-body-1 text-sm-h6 font-weight-bold">éšæœºæ€§ç®—æ³•é…ç½®</span>
        </v-card-title>
        
        <v-card-text class="pa-4 pa-sm-6">
          <v-form ref="configForm" v-model="configValid">
            <!-- åŸºç¡€å¼€å…³é…ç½® -->
            <div class="mb-6">
              <h4 class="mb-4 text-body-1 text-sm-h6 font-weight-bold">åŸºç¡€è®¾ç½®</h4>
              
              <v-card variant="outlined" rounded="lg" class="mb-3 setting-card">
                <v-card-text class="pa-4">
                  <v-switch
                    v-model="randomnessConfig.use_weighted_protection"
                    label="å¯ç”¨ä½æ¦‚ç‡å¥–å“ä¿æŠ¤"
                    color="primary"
                    hide-details
                    class="mb-0"
                  >
                    <template v-slot:append>
                      <v-tooltip location="top">
                        <template v-slot:activator="{ props }">
                          <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                        </template>
                        <span>ä¸ºæ¦‚ç‡è¾ƒä½çš„å¥–å“æä¾›é¢å¤–çš„ä¸­å¥–ä¿æŠ¤æœºåˆ¶</span>
                      </v-tooltip>
                    </template>
                  </v-switch>
                </v-card-text>
              </v-card>
              
              <v-card variant="outlined" rounded="lg" class="mb-3 setting-card">
                <v-card-text class="pa-4">
                  <v-switch
                    v-model="randomnessConfig.use_time_seed_mixing"
                    label="å¯ç”¨æ—¶é—´ç†µæ··åˆ"
                    color="primary"
                    hide-details
                    class="mb-0"
                  >
                    <template v-slot:append>
                      <v-tooltip location="top">
                        <template v-slot:activator="{ props }">
                          <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                        </template>
                        <span>ä½¿ç”¨æ—¶é—´æˆ³å¢å¼ºéšæœºæ•°çš„ä¸å¯é¢„æµ‹æ€§</span>
                      </v-tooltip>
                    </template>
                  </v-switch>
                </v-card-text>
              </v-card>
              
              <v-card variant="outlined" rounded="lg" class="setting-card">
                <v-card-text class="pa-4">
                  <v-switch
                    v-model="randomnessConfig.use_user_seed_mixing"
                    label="å¯ç”¨ç”¨æˆ·IDç†µæ··åˆ"
                    color="primary"
                    hide-details
                    class="mb-0"
                  >
                    <template v-slot:append>
                      <v-tooltip location="top">
                        <template v-slot:activator="{ props }">
                          <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                        </template>
                        <span>ä½¿ç”¨ç”¨æˆ·IDå¢å¼ºéšæœºæ€§ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·çš„æŠ½å¥–ä½“éªŒç‹¬ç‰¹</span>
                      </v-tooltip>
                    </template>
                  </v-switch>
                </v-card-text>
              </v-card>
            </div>

            <v-divider class="mb-6"></v-divider>

            <!-- é«˜çº§å‚æ•°é…ç½® -->
            <div class="mb-6" v-if="randomnessConfig.use_weighted_protection">
              <h4 class="mb-4 text-body-1 text-sm-h6 font-weight-bold">ä¿æŠ¤å‚æ•°</h4>
              
              <v-text-field
                v-model.number="randomnessConfig.protection_threshold"
                label="ä¿æŠ¤é˜ˆå€¼ (%)"
                type="number"
                min="0.1"
                max="50"
                step="0.1"
                :rules="thresholdRules"
                density="compact"
                variant="outlined"
                rounded="lg"
                class="mb-4"
              >
                <template v-slot:append-inner>
                  <v-tooltip location="top">
                    <template v-slot:activator="{ props }">
                      <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                    </template>
                    <span>æ¦‚ç‡ä½äºæ­¤å€¼çš„å¥–å“å°†è·å¾—ä¿æŠ¤åŠ æˆ</span>
                  </v-tooltip>
                </template>
              </v-text-field>
              
              <v-text-field
                v-model.number="randomnessConfig.protection_factor"
                label="ä¿æŠ¤ç³»æ•°"
                type="number"
                min="1.0"
                max="3.0"
                step="0.1"
                :rules="factorRules"
                density="compact"
                variant="outlined"
                rounded="lg"
              >
                <template v-slot:append-inner>
                  <v-tooltip location="top">
                    <template v-slot:activator="{ props }">
                      <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                    </template>
                    <span>ä½æ¦‚ç‡å¥–å“çš„æ¦‚ç‡ä¹˜æ•°ï¼Œè¶Šå¤§ä¿æŠ¤åŠ›åº¦è¶Šå¼º</span>
                  </v-tooltip>
                </template>
              </v-text-field>
            </div>

            <v-divider class="mb-6"></v-divider>

            <!-- å¿«é€Ÿé…ç½® -->
            <div class="mb-6">
              <h4 class="mb-4 text-body-1 text-sm-h6 font-weight-bold">å¿«é€Ÿé…ç½®</h4>
              <v-btn-toggle
                v-model="selectedPreset"
                color="primary"
                variant="outlined"
                divided
                @update:model-value="applyPreset"
                class="preset-toggle"
              >
                <v-btn value="conservative" size="small">ä¿å®ˆæ¨¡å¼</v-btn>
                <v-btn value="balanced" size="small">å¹³è¡¡æ¨¡å¼</v-btn>
                <v-btn value="aggressive" size="small">æ¿€è¿›æ¨¡å¼</v-btn>
              </v-btn-toggle>
            </div>

            <!-- é…ç½®é¢„è§ˆ -->
            <v-alert
              type="info"
              variant="tonal"
              class="mb-4"
            >
              <div class="text-subtitle-2 mb-2 font-weight-bold">å½“å‰é…ç½®æ•ˆæœé¢„è§ˆï¼š</div>
              <ul class="text-body-2">
                <li v-if="randomnessConfig.use_weighted_protection">
                  æ¦‚ç‡ä½äº {{ randomnessConfig.protection_threshold }}% çš„å¥–å“å°†è·å¾— {{ ((randomnessConfig.protection_factor - 1) * 100).toFixed(0) }}% çš„ä¿æŠ¤åŠ æˆ
                </li>
                <li v-else>
                  æ‰€æœ‰å¥–å“ä¸¥æ ¼æŒ‰ç…§è®¾å®šæ¦‚ç‡æ‰§è¡Œ
                </li>
                <li v-if="randomnessConfig.use_time_seed_mixing">
                  å¯ç”¨æ—¶é—´æˆ³éšæœºå¢å¼º
                </li>
                <li v-if="randomnessConfig.use_user_seed_mixing">
                  å¯ç”¨ç”¨æˆ·IDéšæœºå¢å¼º
                </li>
              </ul>
            </v-alert>
          </v-form>
        </v-card-text>
        
        <v-card-actions class="pa-4 pa-sm-6">
          <v-spacer></v-spacer>
          <v-btn size="small" variant="text" @click="showConfigDialog = false">å–æ¶ˆ</v-btn>
          <v-btn
            color="primary"
            :disabled="!configValid"
            :loading="configSaving"
            size="small"
            variant="elevated"
            @click="saveRandomnessConfig"
          >
            ä¿å­˜é…ç½®
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- è½¬ç›˜é…ç½®å¼¹çª— -->
    <v-dialog 
      v-model="showWheelConfigDialog" 
      :max-width="$vuetify.display.xs ? '95vw' : '800'"
      :fullscreen="$vuetify.display.xs"
      persistent
      scrollable
    >
      <v-card rounded="xl" elevation="16" class="wheel-config-dialog">
        <v-card-title class="wheel-config-header pa-4 pa-sm-6">
          <v-avatar size="40" class="mr-3" color="rgba(255,255,255,0.2)" variant="flat">
            <v-icon size="22" color="white">mdi-wheel-spin-outline</v-icon>
          </v-avatar>
          <div class="flex-grow-1">
            <div class="text-h6 font-weight-bold">è½¬ç›˜é…ç½®ç®¡ç†</div>
            <div class="text-body-2 opacity-90">é…ç½®å¥–å“åŠå…¶ä¸­å¥–æ¦‚ç‡</div>
          </div>
          <v-btn 
            icon="mdi-close" 
            variant="text" 
            color="white"
            @click="showWheelConfigDialog = false"
          ></v-btn>
        </v-card-title>
        
        <v-card-text class="pa-4 pa-sm-6">
          <!-- æ¦‚ç‡æ€»è§ˆå¡ç‰‡ -->
          <v-card 
            variant="outlined" 
            rounded="lg" 
            class="mb-6 probability-overview"
            :class="totalProbability === 100 ? 'border-success' : 'border-warning'"
          >
            <v-card-text class="pa-4">
              <div class="d-flex align-center justify-space-between mb-3">
                <div class="d-flex align-center">
                  <v-icon 
                    :color="totalProbability === 100 ? 'success' : 'warning'"
                    class="mr-2"
                  >
                    {{ totalProbability === 100 ? 'mdi-check-circle' : 'mdi-alert-circle' }}
                  </v-icon>
                  <span class="text-h6 font-weight-bold">
                    {{ totalProbability === 100 ? 'æ¦‚ç‡é…ç½®å®Œæˆ' : 'æ¦‚ç‡éœ€è¦è°ƒæ•´' }}
                  </span>
                </div>
                <v-chip 
                  :color="totalProbability === 100 ? 'success' : 'warning'"
                  variant="flat"
                  size="large"
                  class="font-weight-bold"
                >
                  {{ totalProbability }}%
                </v-chip>
              </div>
              
              <!-- æ¦‚ç‡åˆ†å¸ƒæ¡ -->
              <div class="probability-bar-container mb-3">
                <v-progress-linear
                  :model-value="totalProbability"
                  height="12"
                  rounded
                  :color="totalProbability === 100 ? 'success' : 'warning'"
                  :bg-color="totalProbability === 100 ? 'success-lighten-4' : 'warning-lighten-4'"
                ></v-progress-linear>
              </div>
              
              <div class="text-body-2 text-medium-emphasis">
                {{ totalProbability === 100 ? 'âœ“ æ‰€æœ‰æ¦‚ç‡å·²æ­£ç¡®åˆ†é…' : `è¿˜éœ€è°ƒæ•´ ${Math.abs(100 - totalProbability)}%` }}
              </div>
            </v-card-text>
          </v-card>

          <!-- ç§¯åˆ†é…ç½® -->
          <div class="mb-6">
            <h4 class="text-h6 font-weight-bold mb-4 d-flex align-center">
              <v-icon class="mr-2" color="warning">mdi-coin</v-icon>
              ç§¯åˆ†é…ç½®
            </h4>
            
            <v-row>
              <v-col cols="12" sm="6">
                <v-card variant="outlined" rounded="lg" class="credits-config-card" elevation="2">
                  <v-card-text class="pa-4">
                    <div class="d-flex align-center mb-3">
                      <v-avatar size="32" color="warning" variant="flat" class="mr-3">
                        <v-icon size="18" color="white">mdi-ticket</v-icon>
                      </v-avatar>
                      <div>
                        <div class="text-subtitle-1 font-weight-bold">å‚ä¸è´¹ç”¨</div>
                        <div class="text-body-2 text-medium-emphasis">æ¯æ¬¡è½¬ç›˜æ¶ˆè€—çš„ç§¯åˆ†</div>
                      </div>
                    </div>
                    
                    <v-text-field
                      v-model.number="tempWheelConfig.cost_credits"
                      label="æ¶ˆè€—ç§¯åˆ†"
                      type="number"
                      min="1"
                      max="1000"
                      step="1"
                      density="compact"
                      variant="outlined"
                      rounded="lg"
                      :rules="[
                        v => !!v || 'æ¶ˆè€—ç§¯åˆ†ä¸èƒ½ä¸ºç©º',
                        v => v >= 1 || 'æ¶ˆè€—ç§¯åˆ†ä¸èƒ½å°‘äº1',
                        v => v <= 1000 || 'æ¶ˆè€—ç§¯åˆ†ä¸èƒ½è¶…è¿‡1000'
                      ]"
                    >
                      <template v-slot:prepend-inner>
                        <v-icon size="small" color="warning">mdi-minus-circle</v-icon>
                      </template>
                      <template v-slot:append-inner>
                        <v-tooltip location="top">
                          <template v-slot:activator="{ props }">
                            <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                          </template>
                          <span>ç”¨æˆ·æ¯æ¬¡å‚ä¸è½¬ç›˜éœ€è¦æ¶ˆè€—çš„ç§¯åˆ†æ•°é‡</span>
                        </v-tooltip>
                      </template>
                    </v-text-field>
                  </v-card-text>
                </v-card>
              </v-col>
              
              <v-col cols="12" sm="6">
                <v-card variant="outlined" rounded="lg" class="credits-config-card" elevation="2">
                  <v-card-text class="pa-4">
                    <div class="d-flex align-center mb-3">
                      <v-avatar size="32" color="info" variant="flat" class="mr-3">
                        <v-icon size="18" color="white">mdi-shield-check</v-icon>
                      </v-avatar>
                      <div>
                        <div class="text-subtitle-1 font-weight-bold">æœ€ä½é—¨æ§›</div>
                        <div class="text-body-2 text-medium-emphasis">å‚ä¸è½¬ç›˜çš„æœ€ä½ç§¯åˆ†è¦æ±‚</div>
                      </div>
                    </div>
                    
                    <v-text-field
                      v-model.number="tempWheelConfig.min_credits_required"
                      label="æœ€ä½ç§¯åˆ†"
                      type="number"
                      min="1"
                      max="10000"
                      step="1"
                      density="compact"
                      variant="outlined"
                      rounded="lg"
                      :rules="[
                        v => !!v || 'æœ€ä½ç§¯åˆ†ä¸èƒ½ä¸ºç©º',
                        v => v >= 1 || 'æœ€ä½ç§¯åˆ†ä¸èƒ½å°‘äº1',
                        v => v <= 10000 || 'æœ€ä½ç§¯åˆ†ä¸èƒ½è¶…è¿‡10000',
                        v => v >= tempWheelConfig.cost_credits || 'æœ€ä½ç§¯åˆ†ä¸èƒ½å°‘äºæ¶ˆè€—ç§¯åˆ†'
                      ]"
                    >
                      <template v-slot:prepend-inner>
                        <v-icon size="small" color="info">mdi-security</v-icon>
                      </template>
                      <template v-slot:append-inner>
                        <v-tooltip location="top">
                          <template v-slot:activator="{ props }">
                            <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                          </template>
                          <span>ç”¨æˆ·ç§¯åˆ†ä½äºæ­¤å€¼æ—¶æ— æ³•å‚ä¸è½¬ç›˜</span>
                        </v-tooltip>
                      </template>
                    </v-text-field>
                  </v-card-text>
                </v-card>
              </v-col>
            </v-row>
            
            <!-- ç‰¹æƒé‚€è¯·ç é…ç½® -->
            <div class="mt-4">
              <v-card variant="outlined" rounded="lg" class="credits-config-card" elevation="2">
                <v-card-text class="pa-4">
                  <div class="d-flex align-center mb-3">
                    <v-avatar size="32" color="purple" variant="flat" class="mr-3">
                      <v-icon size="18" color="white">mdi-ticket-confirmation</v-icon>
                    </v-avatar>
                    <div>
                      <div class="text-subtitle-1 font-weight-bold">ç‰¹æƒé‚€è¯·ç </div>
                      <div class="text-body-2 text-medium-emphasis">æ˜¯å¦åœ¨å¥–å“ä¸­ç”Ÿæˆç‰¹æƒé‚€è¯·ç </div>
                    </div>
                  </div>
                  
                  <v-switch
                    v-model="tempWheelConfig.gen_privileged_code"
                    label="å¯ç”¨ç‰¹æƒé‚€è¯·ç å¥–å“"
                    color="purple"
                    hide-details
                    class="mb-0"
                  >
                    <template v-slot:append>
                      <v-tooltip location="top">
                        <template v-slot:activator="{ props }">
                          <v-icon v-bind="props" color="grey" size="small">mdi-help-circle-outline</v-icon>
                        </template>
                        <span>å¼€å¯åï¼Œ"é‚€è¯·ç "ç±»å¥–å“å°†ç”Ÿæˆå…·æœ‰ç‰¹æ®Šæƒé™çš„é‚€è¯·ç </span>
                      </v-tooltip>
                    </template>
                  </v-switch>
                </v-card-text>
              </v-card>
            </div>
            
            <!-- ç§¯åˆ†é…ç½®é¢„è§ˆ -->
            <v-alert
              type="info"
              variant="tonal"
              rounded="lg"
              class="mt-4"
            >
              <template v-slot:prepend>
                <v-icon size="large">mdi-information-outline</v-icon>
              </template>
              <div class="text-subtitle-2 mb-2 font-weight-bold">é…ç½®è¯´æ˜</div>
              <ul class="text-body-2">
                <li>
                  ç”¨æˆ·æ¯æ¬¡è½¬ç›˜å°†æ¶ˆè€— <strong>{{ tempWheelConfig.cost_credits }}</strong> ç§¯åˆ†
                </li>
                <li>
                  ç”¨æˆ·ç§¯åˆ†éœ€è¦è‡³å°‘ <strong>{{ tempWheelConfig.min_credits_required }}</strong> æ‰èƒ½å‚ä¸è½¬ç›˜
                </li>
                <li>
                  è½¬ç›˜åç”¨æˆ·æœ€ç»ˆç§¯åˆ† = å½“å‰ç§¯åˆ† - {{ tempWheelConfig.cost_credits }} + å¥–å“ç§¯åˆ†
                </li>
                <li v-if="tempWheelConfig.gen_privileged_code">
                  <v-icon size="small" color="purple" class="mr-1">mdi-ticket-confirmation</v-icon>
                  é‚€è¯·ç å¥–å“å°†ç”Ÿæˆ <strong class="text-purple">ç‰¹æƒé‚€è¯·ç </strong>ï¼Œå…·æœ‰ç‰¹æ®Šæƒé™
                </li>
                <li v-else>
                  <v-icon size="small" color="grey" class="mr-1">mdi-ticket-outline</v-icon>
                  é‚€è¯·ç å¥–å“å°†ç”Ÿæˆ <strong>æ™®é€šé‚€è¯·ç </strong>
                </li>
              </ul>
            </v-alert>
          </div>

          <!-- å¥–å“é…ç½®åˆ—è¡¨ -->
          <div class="mb-4">
            <h4 class="text-h6 font-weight-bold mb-4 d-flex align-center">
              <v-icon class="mr-2" color="primary">mdi-gift-outline</v-icon>
              å¥–å“é…ç½® ({{ tempWheelItems.length }}/10)
            </h4>
            
            <v-row>
              <v-col 
                v-for="(item, index) in tempWheelItems" 
                :key="index" 
                cols="12"
                class="mb-2"
              >
                <v-card 
                  variant="outlined" 
                  rounded="lg" 
                  class="item-config-card"
                  elevation="2"
                >
                  <v-card-text class="pa-4">
                    <div class="d-flex align-center mb-3">
                      <v-avatar 
                        size="32" 
                        :color="getItemColor(index)"
                        variant="flat"
                        class="mr-3"
                      >
                        <span class="text-white font-weight-bold">{{ index + 1 }}</span>
                      </v-avatar>
                      <div class="flex-grow-1">
                        <div class="text-subtitle-1 font-weight-bold">å¥–å“ {{ index + 1 }}</div>
                        <div class="text-body-2 text-medium-emphasis">
                          å½“å‰æ¦‚ç‡ï¼š{{ item.probability || 0 }}%
                        </div>
                      </div>
                      <v-btn 
                        icon
                        size="small" 
                        color="error" 
                        variant="text"
                        @click="removeWheelItem(index)"
                        :disabled="tempWheelItems.length <= 2"
                        class="ml-2"
                      >
                        <v-icon>mdi-delete-outline</v-icon>
                        <v-tooltip activator="parent" location="top">
                          åˆ é™¤å¥–å“
                        </v-tooltip>
                      </v-btn>
                    </div>
                    
                    <v-row>
                      <v-col cols="12" sm="7">
                        <v-text-field 
                          v-model="item.name" 
                          label="å¥–å“åç§°"
                          placeholder="è¾“å…¥å¥–å“åç§°"
                          density="compact"
                          variant="outlined"
                          rounded="lg"
                          hide-details
                          :rules="[v => !!v || 'å¥–å“åç§°ä¸èƒ½ä¸ºç©º']"
                        >
                          <template v-slot:prepend-inner>
                            <v-icon size="small" color="grey">mdi-gift</v-icon>
                          </template>
                        </v-text-field>
                      </v-col>
                      <v-col cols="12" sm="5">
                        <v-text-field 
                          v-model.number="item.probability" 
                          label="ä¸­å¥–æ¦‚ç‡"
                          suffix="%"
                          type="number"
                          min="0"
                          max="100"
                          step="0.01"
                          density="compact"
                          variant="outlined"
                          rounded="lg"
                          hide-details
                          :rules="[
                            v => v >= 0 || 'æ¦‚ç‡ä¸èƒ½ä¸ºè´Ÿæ•°',
                            v => v <= 100 || 'æ¦‚ç‡ä¸èƒ½è¶…è¿‡100%'
                          ]"
                          @blur="normalizeprobability(index)"
                        >
                          <template v-slot:prepend-inner>
                            <v-icon size="small" color="grey">mdi-percent</v-icon>
                          </template>
                        </v-text-field>
                      </v-col>
                    </v-row>
                    
                    <!-- æ¦‚ç‡å¯è§†åŒ–æ¡ -->
                    <div class="mt-3" v-if="item.probability > 0">
                      <v-progress-linear
                        :model-value="item.probability"
                        height="6"
                        rounded
                        :color="getItemColor(index)"
                        :bg-color="getItemColor(index) + '-lighten-4'"
                      ></v-progress-linear>
                    </div>
                  </v-card-text>
                </v-card>
              </v-col>
            </v-row>
          </div>
          
          <!-- æ·»åŠ å¥–å“æŒ‰é’® -->
          <div class="text-center mb-4">
            <v-btn 
              @click="addWheelItem" 
              color="primary" 
              variant="tonal"
              size="large"
              rounded="lg"
              :disabled="tempWheelItems.length >= 10"
              class="add-item-btn mr-3"
            >
              <v-icon class="mr-2">mdi-plus-circle</v-icon>
              æ·»åŠ æ–°å¥–å“
              <v-tooltip activator="parent" location="top">
                æœ€å¤šå¯æ·»åŠ  10 ä¸ªå¥–å“
              </v-tooltip>
            </v-btn>
            
            <!-- æ¦‚ç‡ç®¡ç†æŒ‰é’® -->
            <v-btn 
              @click="autoDistributeProbability" 
              color="success" 
              variant="tonal"
              size="large"
              rounded="lg"
              class="mr-3"
            >
              <v-icon class="mr-2">mdi-auto-fix</v-icon>
              å¹³å‡åˆ†é…
              <v-tooltip activator="parent" location="top">
                å°†100%æ¦‚ç‡å¹³å‡åˆ†é…ç»™æ‰€æœ‰å¥–å“
              </v-tooltip>
            </v-btn>
            
            <v-btn 
              @click="clearAllProbability" 
              color="warning" 
              variant="tonal"
              size="large"
              rounded="lg"
            >
              <v-icon class="mr-2">mdi-refresh</v-icon>
              æ¸…ç©ºæ¦‚ç‡
              <v-tooltip activator="parent" location="top">
                å°†æ‰€æœ‰å¥–å“æ¦‚ç‡è®¾ä¸º0
              </v-tooltip>
            </v-btn>
          </div>
          
          <!-- è­¦å‘Šæç¤º -->
          <v-alert 
            v-if="totalProbability !== 100" 
            type="warning" 
            variant="tonal"
            rounded="lg"
            class="mb-4"
            prominent
          >
            <template v-slot:prepend>
              <v-icon size="large">mdi-alert-circle</v-icon>
            </template>
            <div class="text-subtitle-1 font-weight-bold mb-2">æ¦‚ç‡é…ç½®ä¸å®Œæ•´</div>
            <div class="text-body-2 mb-3">
              å½“å‰æ€»æ¦‚ç‡ä¸º <strong>{{ totalProbability }}%</strong>ï¼Œ
              {{ totalProbability < 100 ? `è¿˜éœ€è¦åˆ†é… ${(100 - totalProbability).toFixed(2)}%` : `è¶…å‡ºäº† ${(totalProbability - 100).toFixed(2)}%` }}
            </div>
            
            <!-- å¿«é€Ÿè°ƒæ•´æŒ‰é’® -->
            <div class="d-flex flex-wrap gap-2" v-if="totalProbability !== 100">
              <v-btn
                v-if="totalProbability < 100"
                @click="adjustProbabilityToTotal"
                color="warning"
                variant="outlined"
                size="small"
                rounded="lg"
              >
                <v-icon class="mr-1" size="small">mdi-plus</v-icon>
                è¡¥é½åˆ°100%
              </v-btn>
              
              <v-btn
                v-if="totalProbability > 100"
                @click="normalizeProbabilityToTotal"
                color="warning"
                variant="outlined"
                size="small"
                rounded="lg"
              >
                <v-icon class="mr-1" size="small">mdi-percent</v-icon>
                æŒ‰æ¯”ä¾‹è°ƒæ•´
              </v-btn>
            </div>
          </v-alert>

          <!-- æˆåŠŸæç¤º -->
          <v-alert 
            v-if="totalProbability === 100" 
            type="success" 
            variant="tonal"
            rounded="lg"
            class="mb-4"
          >
            <template v-slot:prepend>
              <v-icon size="large">mdi-check-circle</v-icon>
            </template>
            <div class="text-subtitle-1 font-weight-bold">é…ç½®å®Œæˆ</div>
            <div class="text-body-2">æ‰€æœ‰å¥–å“çš„æ¦‚ç‡å·²æ­£ç¡®åˆ†é…ï¼Œå¯ä»¥ä¿å­˜é…ç½®äº†ï¼</div>
          </v-alert>
        </v-card-text>
        
        <v-card-actions class="pa-4 pa-sm-6 bg-grey-lighten-5">
          <v-spacer></v-spacer>
          <v-btn 
            variant="text" 
            @click="showWheelConfigDialog = false"
            class="mr-2"
          >
            å–æ¶ˆ
          </v-btn>
          <v-btn
            color="primary"
            :disabled="!isValidConfig"
            :loading="configSaving"
            variant="elevated"
            rounded="lg"
            @click="saveWheelConfig"
          >
            <v-icon class="mr-2">mdi-content-save</v-icon>
            ä¿å­˜é…ç½®
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<script>
import LuckyWheel from '@/components/LuckyWheel.vue'
import { getLuckyWheelRandomnessConfig, getLuckyWheelRandomnessStats, updateLuckyWheelRandomnessConfig, getLuckyWheelConfig, updateLuckyWheelConfig } from '@/services/wheelService'

export default {
  name: 'WheelAdminPanel',
  components: {
    LuckyWheel
  },
  data() {
    return {
      showTestDialog: false,
      showConfigDialog: false,
      showWheelConfigDialog: false,
      wheelItems: [],
      tempWheelItems: [],
      wheelConfig: {
        cost_credits: 10,
        min_credits_required: 30,
        gen_privileged_code: false
      },
      tempWheelConfig: {
        cost_credits: 10,
        min_credits_required: 30,
        gen_privileged_code: false
      },
      randomnessConfig: {
        use_weighted_protection: true,
        protection_threshold: 2.0,
        protection_factor: 1.2,
        use_time_seed_mixing: true,
        use_user_seed_mixing: true
      },
      lastTestResult: null,
      testRunning: false,
      testIterations: 10000,
      currentTestResult: null,
      configValid: false,
      configSaving: false,
      selectedPreset: null,
      thresholdRules: [
        v => !!v || 'ä¿æŠ¤é˜ˆå€¼ä¸èƒ½ä¸ºç©º',
        v => (v >= 0.1 && v <= 50) || 'ä¿æŠ¤é˜ˆå€¼å¿…é¡»åœ¨ 0.1% åˆ° 50% ä¹‹é—´'
      ],
      factorRules: [
        v => !!v || 'ä¿æŠ¤ç³»æ•°ä¸èƒ½ä¸ºç©º',
        v => (v >= 1.0 && v <= 3.0) || 'ä¿æŠ¤ç³»æ•°å¿…é¡»åœ¨ 1.0 åˆ° 3.0 ä¹‹é—´'
      ],
      presets: {
        conservative: {
          use_weighted_protection: true,
          protection_threshold: 5.0,
          protection_factor: 1.5,
          use_time_seed_mixing: true,
          use_user_seed_mixing: true
        },
        balanced: {
          use_weighted_protection: true,
          protection_threshold: 2.0,
          protection_factor: 1.2,
          use_time_seed_mixing: true,
          use_user_seed_mixing: true
        },
        aggressive: {
          use_weighted_protection: false,
          protection_threshold: 1.0,
          protection_factor: 1.0,
          use_time_seed_mixing: true,
          use_user_seed_mixing: false
        }
      }
    }
  },
  mounted() {
    this.loadRandomnessConfig()
    this.loadLastTestResult()
    this.loadWheelConfig()
  },
  computed: {
    totalProbability() {
      // ä½¿ç”¨æ›´ç²¾ç¡®çš„æµ®ç‚¹æ•°è®¡ç®—æ–¹æ³•
      const total = this.tempWheelItems.reduce((sum, item) => {
        const prob = parseFloat(item.probability) || 0
        return sum + prob
      }, 0)
      // ä¿ç•™ä¸¤ä½å°æ•°å¹¶è§£å†³æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
      return Math.round((total + Number.EPSILON) * 100) / 100
    },
    isValidConfig() {
      // æ£€æŸ¥æ‰€æœ‰å¥–å“é…ç½®æ˜¯å¦æœ‰æ•ˆ
      const allItemsValid = this.tempWheelItems.every(item => 
        item.name && item.name.trim() !== '' && 
        item.probability >= 0 && 
        item.probability <= 100 &&
        !isNaN(item.probability)
      )
      
      // æ£€æŸ¥æ¦‚ç‡æ€»å’Œæ˜¯å¦ä¸º100%ï¼ˆå…è®¸0.01çš„è¯¯å·®ï¼‰
      const totalValid = Math.abs(this.totalProbability - 100) <= 0.01
      
      // æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰2ä¸ªå¥–å“
      const countValid = this.tempWheelItems.length >= 2
      
      // æ£€æŸ¥ç§¯åˆ†é…ç½®æ˜¯å¦æœ‰æ•ˆ
      const creditsValid = this.tempWheelConfig.cost_credits >= 1 && 
                          this.tempWheelConfig.cost_credits <= 1000 &&
                          this.tempWheelConfig.min_credits_required >= 1 && 
                          this.tempWheelConfig.min_credits_required <= 10000 &&
                          this.tempWheelConfig.min_credits_required >= this.tempWheelConfig.cost_credits &&
                          !isNaN(this.tempWheelConfig.cost_credits) &&
                          !isNaN(this.tempWheelConfig.min_credits_required)
      
      return allItemsValid && totalValid && countValid && creditsValid
    },
    testAnalysis() {
      if (!this.currentTestResult || !this.currentTestResult.stats) {
        return null
      }

      const stats = this.currentTestResult.stats
      const overallFairness = this.currentTestResult.overall_fairness
      const averageDeviation = this.currentTestResult.average_deviation

      // åˆ†æå¼‚å¸¸é¡¹ç›®
      const unfairItems = stats.filter(stat => !stat.is_fair)
      const highDeviationItems = stats.filter(stat => Math.abs(stat.deviation) > 5)
      
      let analysis = {
        type: 'success',
        icon: 'mdi-check-circle',
        title: 'æµ‹è¯•ç»“æœè‰¯å¥½',
        message: 'æ‰€æœ‰å¥–å“çš„éšæœºæ€§è¡¨ç°æ­£å¸¸ï¼Œæ¦‚ç‡åˆ†å¸ƒç¬¦åˆé¢„æœŸã€‚',
        suggestions: []
      }

      if (!overallFairness || unfairItems.length > 0) {
        analysis.type = 'warning'
        analysis.icon = 'mdi-alert-circle'
        analysis.title = 'å‘ç°éšæœºæ€§å¼‚å¸¸'
        analysis.message = `æœ‰ ${unfairItems.length} ä¸ªå¥–å“çš„æ¦‚ç‡åˆ†å¸ƒå­˜åœ¨å¼‚å¸¸ï¼Œå¹³å‡åå·®ä¸º ${averageDeviation}%ã€‚`
        
        if (highDeviationItems.length > 0) {
          analysis.suggestions.push(`${highDeviationItems.length} ä¸ªå¥–å“åå·®è¶…è¿‡5%ï¼Œå»ºè®®è°ƒæ•´éšæœºæ€§å‚æ•°`)
        }
        
        if (unfairItems.some(item => item.deviation > 10)) {
          analysis.suggestions.push('éƒ¨åˆ†å¥–å“åå·®è¿‡å¤§ï¼Œå»ºè®®å¯ç”¨ä½æ¦‚ç‡ä¿æŠ¤æœºåˆ¶')
        }
        
        if (this.randomnessConfig.use_weighted_protection && unfairItems.length > 0) {
          analysis.suggestions.push('å¯ä»¥å°è¯•è°ƒæ•´ä¿æŠ¤é˜ˆå€¼æˆ–ä¿æŠ¤ç³»æ•°')
        }
        
        if (!this.randomnessConfig.use_time_seed_mixing || !this.randomnessConfig.use_user_seed_mixing) {
          analysis.suggestions.push('å»ºè®®å¯ç”¨æ—¶é—´ç†µå’Œç”¨æˆ·IDç†µæ··åˆä»¥å¢å¼ºéšæœºæ€§')
        }
      }

      if (averageDeviation > 3) {
        analysis.type = 'error'
        analysis.icon = 'mdi-alert-circle-outline'
        analysis.title = 'éšæœºæ€§ä¸¥é‡å¼‚å¸¸'
        analysis.message = `å¹³å‡åå·®é«˜è¾¾ ${averageDeviation}%ï¼Œéšæœºç®—æ³•å¯èƒ½å­˜åœ¨é—®é¢˜ã€‚`
        analysis.suggestions.push('å»ºè®®ç«‹å³æ£€æŸ¥å’Œè°ƒæ•´éšæœºæ€§é…ç½®')
        analysis.suggestions.push('è€ƒè™‘å¢åŠ æµ‹è¯•æ¬¡æ•°ä»¥è·å¾—æ›´å‡†ç¡®çš„ç»“æœ')
      }

      return analysis
    }
  },
  methods: {
    async loadRandomnessConfig() {
      try {
        const response = await getLuckyWheelRandomnessConfig()
        if (response.data && Object.keys(response.data).length > 0) {
          this.randomnessConfig = { ...this.randomnessConfig, ...response.data }
        }
      } catch (error) {
        console.error('åŠ è½½éšæœºæ€§é…ç½®å¤±è´¥:', error)
        // ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œä¸æ¸…ç©ºç°æœ‰é…ç½®
        console.log('ä½¿ç”¨é»˜è®¤éšæœºæ€§é…ç½®')
      }
    },

    loadLastTestResult() {
      // ä»æœ¬åœ°å­˜å‚¨æˆ–APIåŠ è½½æœ€è¿‘çš„æµ‹è¯•ç»“æœ
      const stored = localStorage.getItem('lastRandomnessTest')
      if (stored) {
        this.lastTestResult = JSON.parse(stored)
      }
    },

    async loadWheelConfig() {
      try {
        const response = await getLuckyWheelConfig()
        this.wheelItems = response.data.items || []
        this.wheelConfig = {
          cost_credits: response.data.cost_credits || 10,
          min_credits_required: response.data.min_credits_required || 30,
          gen_privileged_code: response.data.gen_privileged_code || false
        }
      } catch (error) {
        console.error('åŠ è½½è½¬ç›˜é…ç½®å¤±è´¥:', error)
        this.wheelItems = []
        this.wheelConfig = {
          cost_credits: 10,
          min_credits_required: 30,
          gen_privileged_code: false
        }
      }
    },

    openWheelConfig() {
      this.tempWheelItems = JSON.parse(JSON.stringify(this.wheelItems))
      this.tempWheelConfig = JSON.parse(JSON.stringify(this.wheelConfig))
      this.showWheelConfigDialog = true
    },

    openRandomnessTest() {
      // ç›´æ¥åœ¨å½“å‰ç»„ä»¶ä¸­æ˜¾ç¤ºæµ‹è¯•å¯¹è¯æ¡†
      this.showTestDialog = true
    },

    openRandomnessConfig() {
      this.showConfigDialog = true
    },

    viewStats() {
      // è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢
      this.$router.push('/admin/wheel-stats')
    },

    onConfigUpdated(newConfig) {
      this.randomnessConfig = { ...newConfig }
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      this.$emit('show-message', 'éšæœºæ€§é…ç½®æ›´æ–°æˆåŠŸ')
    },

    applyPreset(presetName) {
      if (presetName && this.presets[presetName]) {
        this.randomnessConfig = { ...this.presets[presetName] }
      }
    },

    async saveRandomnessConfig() {
      if (!this.configValid) return
      
      this.configSaving = true
      try {
        await updateLuckyWheelRandomnessConfig(this.randomnessConfig)
        
        this.showConfigDialog = false
        this.selectedPreset = null
        
        // é‡æ–°åŠ è½½é…ç½®ä»¥ç¡®ä¿æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
        await this.loadRandomnessConfig()
        
        // é€šçŸ¥ LuckyWheel ç»„ä»¶é‡æ–°åŠ è½½é…ç½®
        if (this.$refs.luckyWheel) {
          this.$refs.luckyWheel.reloadConfig()
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        this.$emit('show-message', 'éšæœºæ€§é…ç½®æ›´æ–°æˆåŠŸ')
        
        console.log('éšæœºæ€§é…ç½®æ›´æ–°æˆåŠŸ')
      } catch (error) {
        console.error('ä¿å­˜éšæœºæ€§é…ç½®å¤±è´¥:', error)
        alert('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
      } finally {
        this.configSaving = false
      }
    },

    async runRandomnessTest() {
      if (this.testRunning) return
      
      this.testRunning = true
      this.currentTestResult = null
      
      try {
        console.log('å¼€å§‹éšæœºæ€§æµ‹è¯•ï¼Œè¿­ä»£æ¬¡æ•°:', this.testIterations)
        const response = await getLuckyWheelRandomnessStats(this.testIterations)
        console.log('APIå“åº”:', response.data)
        
        // å¤„ç†APIè¿”å›çš„æ•°æ®
        const data = response.data
        
        // å°† stats å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ï¼Œä»¥ä¾¿å‰ç«¯ä½¿ç”¨
        const statsArray = Object.entries(data.stats || {}).map(([name, stat]) => ({
          name: name,
          expected_probability: stat.expected_rate,
          actual_probability: stat.actual_rate,
          deviation: stat.deviation,
          count: stat.win_count,
          is_fair: stat.is_fair
        }))
        
        this.currentTestResult = {
          iterations: data.iterations,
          valid_items: data.valid_items,
          average_deviation: data.average_deviation,
          overall_fairness: data.overall_fairness,
          stats: statsArray,
          timestamp: new Date().toISOString()
        }
        
        // æ›´æ–°éšæœºæ€§é…ç½®ï¼ˆå¦‚æœAPIè¿”å›äº†é…ç½®ä¿¡æ¯ï¼‰
        if (data.config) {
          this.randomnessConfig = { ...this.randomnessConfig, ...data.config }
        }
        
        // ä¿å­˜ä¸ºæœ€è¿‘æµ‹è¯•ç»“æœ
        this.lastTestResult = { ...this.currentTestResult }
        localStorage.setItem('lastRandomnessTest', JSON.stringify(this.lastTestResult))
        
        console.log('éšæœºæ€§æµ‹è¯•å®Œæˆ:', this.currentTestResult)
      } catch (error) {
        console.error('éšæœºæ€§æµ‹è¯•å¤±è´¥:', error)
        console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data)
        const errorMessage = error.response?.data?.detail || error.message || 'éšæœºæ€§æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
        alert(errorMessage)
      } finally {
        this.testRunning = false
      }
    },

    onTestCompleted(result) {
      this.lastTestResult = {
        ...result,
        timestamp: new Date().toISOString()
      }
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('lastRandomnessTest', JSON.stringify(this.lastTestResult))
      
      this.showTestDialog = false
    },

    formatDate(timestamp) {
      return new Date(timestamp).toLocaleDateString('zh-CN')
    },

    // è½¬ç›˜äº‹ä»¶å¤„ç†æ–¹æ³•
    onSpinComplete(result) {
      console.log('è½¬ç›˜å®Œæˆ:', result)
    },

    onResultClosed(result) {
      console.log('ç»“æœå¼¹çª—å…³é—­:', result)
    },

    async saveWheelConfig() {
      // æ£€æŸ¥æ¦‚ç‡æ€»å’Œæ˜¯å¦ç²¾ç¡®ä¸º100%
      const totalProb = this.totalProbability
      if (Math.abs(totalProb - 100) > 0.01) {
        alert(`æ€»æ¦‚ç‡å¿…é¡»ä¸º100%ï¼Œå½“å‰ä¸º${totalProb}%ï¼Œè¯·æ£€æŸ¥é…ç½®`)
        return
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰æ— æ•ˆçš„é…ç½®é¡¹
      const invalidItems = this.tempWheelItems.filter(item => 
        !item.name || item.name.trim() === '' || 
        item.probability < 0 || 
        item.probability > 100 ||
        isNaN(item.probability)
      )
      
      if (invalidItems.length > 0) {
        alert('å­˜åœ¨æ— æ•ˆçš„å¥–å“é…ç½®ï¼Œè¯·æ£€æŸ¥å¥–å“åç§°å’Œæ¦‚ç‡è®¾ç½®')
        return
      }

      this.configSaving = true
      try {
        // åœ¨ä¿å­˜å‰å†æ¬¡è§„èŒƒåŒ–æ‰€æœ‰æ¦‚ç‡å€¼
        this.tempWheelItems.forEach(item => {
          item.probability = Math.round((parseFloat(item.probability) + Number.EPSILON) * 100) / 100
        })
        
        const configData = {
          items: this.tempWheelItems,
          cost_credits: this.tempWheelConfig.cost_credits,
          min_credits_required: this.tempWheelConfig.min_credits_required,
          gen_privileged_code: this.tempWheelConfig.gen_privileged_code
        }
        
        await updateLuckyWheelConfig(configData)
        
        // æ›´æ–°æœ¬åœ°é…ç½®
        this.wheelItems = JSON.parse(JSON.stringify(this.tempWheelItems))
        this.wheelConfig = JSON.parse(JSON.stringify(this.tempWheelConfig))
        this.showWheelConfigDialog = false
        
        // é€šçŸ¥ LuckyWheel ç»„ä»¶é‡æ–°åŠ è½½é…ç½®
        if (this.$refs.luckyWheel) {
          this.$refs.luckyWheel.reloadConfig()
        }
        
        this.$emit('show-message', 'è½¬ç›˜é…ç½®æ›´æ–°æˆåŠŸ')
        console.log('è½¬ç›˜é…ç½®æ›´æ–°æˆåŠŸ')
        
      } catch (error) {
        console.error('æ›´æ–°è½¬ç›˜é…ç½®å¤±è´¥:', error)
        const errorMessage = error.response?.data?.detail || 'æ›´æ–°é…ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
        alert(errorMessage)
      } finally {
        this.configSaving = false
      }
    },

    addWheelItem() {
      this.tempWheelItems.push({ 
        name: `æ–°å¥–å“ ${this.tempWheelItems.length + 1}`, 
        probability: 0 
      })
    },

    removeWheelItem(index) {
      if (this.tempWheelItems.length > 2) {
        this.tempWheelItems.splice(index, 1)
      }
    },

    getItemColor(index) {
      const colors = [
        'primary', 'secondary', 'success', 'info', 
        'warning', 'error', 'purple', 'teal'
      ]
      return colors[index % colors.length]
    },

    getDeviationColor(deviation) {
      const absDeviation = Math.abs(deviation)
      if (absDeviation <= 2) return 'success'
      if (absDeviation <= 5) return 'warning'
      return 'error'
    },

    getFairnessColor(isFair) {
      return isFair ? 'success' : 'error'
    },

    getStatCardClass(stat) {
      const deviation = Math.abs(stat.deviation)
      if (deviation <= 2) return 'stat-card-success'
      if (deviation <= 5) return 'stat-card-warning'
      return 'stat-card-error'
    },

    // æ¦‚ç‡ç®¡ç†è¾…åŠ©æ–¹æ³•
    normalizeprobability(index) {
      // è§„èŒƒåŒ–å•ä¸ªæ¦‚ç‡å€¼ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
      const item = this.tempWheelItems[index]
      if (item && item.probability !== undefined) {
        item.probability = Math.round((parseFloat(item.probability) + Number.EPSILON) * 100) / 100
      }
    },

    autoDistributeProbability() {
      // å¹³å‡åˆ†é…æ¦‚ç‡
      if (this.tempWheelItems.length === 0) return
      
      const averageProbability = 100 / this.tempWheelItems.length
      const roundedProbability = Math.floor(averageProbability * 100) / 100
      const remainder = 100 - (roundedProbability * this.tempWheelItems.length)
      
      this.tempWheelItems.forEach((item, index) => {
        item.probability = roundedProbability
        // å°†ä½™æ•°åˆ†é…ç»™å‰å‡ ä¸ªå¥–å“
        if (index < Math.round(remainder * 100)) {
          item.probability += 0.01
        }
      })
      
      // ç¡®ä¿ç²¾ç¡®ä¸º100%
      this.adjustProbabilityToExact100()
    },

    clearAllProbability() {
      // æ¸…ç©ºæ‰€æœ‰æ¦‚ç‡
      this.tempWheelItems.forEach(item => {
        item.probability = 0
      })
    },

    adjustProbabilityToTotal() {
      // è¡¥é½åˆ°100%ï¼Œå°†å·®å€¼åŠ åˆ°ç¬¬ä¸€ä¸ªå¥–å“ä¸Š
      if (this.tempWheelItems.length === 0) return
      
      const difference = 100 - this.totalProbability
      if (difference > 0) {
        this.tempWheelItems[0].probability = (this.tempWheelItems[0].probability || 0) + difference
        this.tempWheelItems[0].probability = Math.round((this.tempWheelItems[0].probability + Number.EPSILON) * 100) / 100
      }
    },

    normalizeProbabilityToTotal() {
      // æŒ‰æ¯”ä¾‹è°ƒæ•´æ‰€æœ‰æ¦‚ç‡ä½¿å…¶æ€»å’Œä¸º100%
      if (this.totalProbability === 0) return
      
      const factor = 100 / this.totalProbability
      let newTotal = 0
      
      this.tempWheelItems.forEach((item) => {
        const newProbability = (item.probability || 0) * factor
        item.probability = Math.round((newProbability + Number.EPSILON) * 100) / 100
        newTotal += item.probability
      })
      
      // å¤„ç†èˆå…¥è¯¯å·®
      const finalDifference = 100 - newTotal
      if (Math.abs(finalDifference) > 0.01) {
        // å°†å·®å€¼åˆ†é…ç»™æ¦‚ç‡æœ€å¤§çš„å¥–å“
        const maxIndex = this.tempWheelItems.reduce((maxIdx, item, idx) => 
          (item.probability || 0) > (this.tempWheelItems[maxIdx].probability || 0) ? idx : maxIdx, 0)
        this.tempWheelItems[maxIndex].probability += finalDifference
        this.tempWheelItems[maxIndex].probability = Math.round((this.tempWheelItems[maxIndex].probability + Number.EPSILON) * 100) / 100
      }
    },

    adjustProbabilityToExact100() {
      // ç²¾ç¡®è°ƒæ•´åˆ°100%ï¼Œå¤„ç†èˆå…¥è¯¯å·®
      const currentTotal = this.totalProbability
      if (Math.abs(currentTotal - 100) < 0.01) return
      
      const difference = 100 - currentTotal
      if (this.tempWheelItems.length > 0) {
        // æ‰¾åˆ°æ¦‚ç‡æœ€å¤§çš„å¥–å“è¿›è¡Œå¾®è°ƒ
        const maxIndex = this.tempWheelItems.reduce((maxIdx, item, idx) => 
          (item.probability || 0) > (this.tempWheelItems[maxIdx].probability || 0) ? idx : maxIdx, 0)
        
        this.tempWheelItems[maxIndex].probability += difference
        this.tempWheelItems[maxIndex].probability = Math.round((this.tempWheelItems[maxIndex].probability + Number.EPSILON) * 100) / 100
      }
    }
  }
}
</script>

<style scoped>
/* ä¸»é¢æ¿æ ·å¼ */
.admin-panel {
  min-height: 100vh;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  padding: 16px 0;
}

@media (min-width: 600px) {
  .admin-panel {
    padding: 24px 0;
  }
}

/* ç»Ÿä¸€çš„å¡ç‰‡æ ·å¼ */
.admin-card {
  height: 100%;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  border: 1px solid rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.admin-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
}

.admin-card-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 16px 16px 0 0 !important;
  min-height: 64px;
}

.admin-card .v-card-text {
  min-height: 80px;
  display: flex;
  align-items: center;
  background: rgba(255, 255, 255, 0.95);
}

.admin-card .v-card-actions {
  background: rgba(255, 255, 255, 0.95);
  border-top: 1px solid rgba(0, 0, 0, 0.06);
}

/* é¢„è§ˆå¡ç‰‡æ ·å¼ */
.preview-card {
  border: 1px solid rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.preview-card-header {
  background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
  color: white;
  border-radius: 16px 16px 0 0 !important;
}

.wheel-preview-container {
  max-width: 320px;
  margin: 0 auto;
  padding: 16px;
  background: radial-gradient(circle at center, rgba(156, 39, 176, 0.05) 0%, transparent 70%);
  border-radius: 16px;
}

@media (min-width: 600px) {
  .wheel-preview-container {
    max-width: 400px;
    padding: 24px;
  }
}

/* é…ç½®å¡ç‰‡æ ·å¼ */
.config-card {
  border: 1px solid rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.config-card-header {
  background: linear-gradient(135deg, #009688 0%, #4caf50 100%);
  color: white;
  border-radius: 16px 16px 0 0 !important;
}

.config-item {
  text-align: center;
  padding: 8px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.7);
  margin: 4px 0;
  transition: all 0.2s ease;
}

.config-item:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateY(-1px);
}

.config-label {
  font-size: 0.75rem;
  color: rgba(0, 0, 0, 0.6);
  margin-bottom: 4px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.config-value {
  font-weight: 600;
  font-size: 0.875rem;
}

.config-number {
  color: #1976d2;
  font-family: 'Monaco', 'Courier New', monospace;
}

.config-chip {
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.25px;
}

.config-btn {
  border-width: 2px;
  font-weight: 600;
}

@media (min-width: 600px) {
  .config-label {
    font-size: 0.8rem;
  }
  
  .config-value {
    font-size: 1rem;
  }
}

/* ç»“æœå¡ç‰‡æ ·å¼ */
.result-card {
  border: 1px solid rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.result-card-header {
  background: linear-gradient(135deg, #673ab7 0%, #3f51b5 100%);
  color: white;
  border-radius: 16px 16px 0 0 !important;
}

.result-chip {
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
.stat-card {
  border: 2px solid rgba(0, 0, 0, 0.06);
  border-radius: 12px !important;
  transition: all 0.2s ease;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
}

.stat-card:hover {
  border-color: rgba(25, 118, 210, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.test-result-row .v-col {
  padding: 8px 6px;
}

@media (min-width: 600px) {
  .test-result-row .v-col {
    padding: 12px 8px;
  }
}

/* å¯¹è¯æ¡†æ ·å¼ */
.dialog-card {
  border: 1px solid rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.dialog-header {
  background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
  color: white;
  border-radius: 16px 16px 0 0 !important;
  position: sticky;
  top: 0;
  z-index: 2;
}

/* è®¾ç½®å¡ç‰‡æ ·å¼ */
.setting-card {
  border: 2px solid rgba(0, 0, 0, 0.06);
  border-radius: 12px !important;
  transition: all 0.2s ease;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
}

.setting-card:hover {
  border-color: rgba(25, 118, 210, 0.2);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

/* é¢„è®¾é…ç½®æŒ‰é’®ç»„ */
.preset-toggle {
  width: 100%;
  border-radius: 12px !important;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.preset-toggle .v-btn {
  flex: 1;
  border-radius: 0 !important;
  font-weight: 600;
  letter-spacing: 0.25px;
}

.preset-toggle .v-btn:first-child {
  border-radius: 12px 0 0 12px !important;
}

.preset-toggle .v-btn:last-child {
  border-radius: 0 12px 12px 0 !important;
}

/* å…¨å±€æŒ‰é’®æ ·å¼ä¼˜åŒ– */
.v-btn {
  border-radius: 12px !important;
  font-weight: 600;
  letter-spacing: 0.25px;
  text-transform: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.v-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

/* è¡¨å•å­—æ®µæ ·å¼ */
.v-text-field .v-field {
  border-radius: 12px !important;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
}

.v-switch {
  border-radius: 8px;
}

/* èŠ¯ç‰‡æ ·å¼ */
.v-chip {
  border-radius: 8px !important;
  font-weight: 600;
  letter-spacing: 0.25px;
}

/* è¿›åº¦ç¯æ ·å¼ */
.v-progress-circular {
  filter: drop-shadow(0 2px 8px rgba(25, 118, 210, 0.3));
}

/* å°å±å¹•ä¼˜åŒ– */
@media (max-width: 599px) {
  .admin-panel {
    padding: 12px 0;
  }
  
  .admin-card-header {
    min-height: 56px;
  }
  
  .admin-card .v-card-text {
    min-height: 64px;
  }
  
  .admin-card .v-card-title span {
    font-size: 0.8rem;
    line-height: 1.2;
  }
  
  .admin-card .v-card-text div {
    font-size: 0.75rem;
    line-height: 1.3;
  }
  
  .test-result-row .text-caption {
    font-size: 0.65rem;
  }
  
  .config-item {
    padding: 6px;
    margin: 2px 0;
  }
  
  .wheel-preview-container {
    max-width: 280px;
    padding: 12px;
  }
  
  .dialog-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
}

/* æ·±è‰²æ¨¡å¼æ”¯æŒ */
@media (prefers-color-scheme: dark) {
  .admin-panel {
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
  }
  
  .stat-card,
  .setting-card {
    background: linear-gradient(135deg, rgba(45, 55, 72, 0.9) 0%, rgba(26, 32, 44, 0.9) 100%);
    border-color: rgba(255, 255, 255, 0.1);
  }
  
  .config-item {
    background: rgba(45, 55, 72, 0.6);
    color: white;
  }
  
  .config-item:hover {
    background: rgba(45, 55, 72, 0.8);
  }
}

/* è½¬ç›˜é…ç½®å¼¹çª—æ ·å¼ */
.wheel-config-dialog {
  max-height: 90vh;
  overflow: hidden;
}

.wheel-config-header {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  color: white;
  border-radius: 16px 16px 0 0 !important;
  position: sticky;
  top: 0;
  z-index: 10;
}

/* æ¦‚ç‡æ€»è§ˆå¡ç‰‡æ ·å¼ */
.probability-overview {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
  border-width: 2px !important;
  transition: all 0.3s ease;
}

.probability-overview.border-success {
  border-color: rgb(var(--v-theme-success)) !important;
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.2);
}

.probability-overview.border-warning {
  border-color: rgb(var(--v-theme-warning)) !important;
  box-shadow: 0 4px 16px rgba(255, 152, 0, 0.2);
}

.probability-bar-container {
  position: relative;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 8px;
  padding: 2px;
}

/* å¥–å“é…ç½®å¡ç‰‡æ ·å¼ */
.item-config-card {
  border: 2px solid rgba(0, 0, 0, 0.08);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
  position: relative;
  overflow: hidden;
}

.item-config-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, 
    rgb(var(--v-theme-primary)) 0%, 
    rgb(var(--v-theme-secondary)) 50%, 
    rgb(var(--v-theme-success)) 100%
  );
  opacity: 0;
  transition: opacity 0.3s ease;
}

.item-config-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  border-color: rgba(25, 118, 210, 0.3);
}

.item-config-card:hover::before {
  opacity: 1;
}

/* æ·»åŠ å¥–å“æŒ‰é’®æ ·å¼ */
.add-item-btn {
  min-width: 160px;
  height: 56px;
  font-weight: 600;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.add-item-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 32px rgba(25, 118, 210, 0.4);
}

.add-item-btn:disabled {
  opacity: 0.6;
  transform: none !important;
  box-shadow: none !important;
}

/* æ¦‚ç‡ç®¡ç†æŒ‰é’®æ ·å¼ */
.v-btn.mr-3 {
  margin-right: 12px;
}

/* å¿«é€Ÿè°ƒæ•´æŒ‰é’®æ ·å¼ */
.gap-2 {
  gap: 8px;
}

/* è¡¨å•å­—æ®µå¢å¼ºæ ·å¼ */
.item-config-card .v-text-field .v-field {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 0, 0, 0.08);
  transition: all 0.2s ease;
}

.item-config-card .v-text-field .v-field:hover {
  background: rgba(255, 255, 255, 0.95);
  border-color: rgba(25, 118, 210, 0.3);
}

.item-config-card .v-text-field .v-field--focused {
  background: white;
  border-color: rgb(var(--v-theme-primary));
  box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
}

/* è¿›åº¦æ¡æ ·å¼å¢å¼º */
.v-progress-linear {
  border-radius: 6px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.v-progress-linear .v-progress-linear__background {
  opacity: 0.3;
}

.v-progress-linear .v-progress-linear__determinate {
  background: linear-gradient(90deg, currentColor 0%, rgba(255, 255, 255, 0.3) 50%, currentColor 100%);
  background-size: 20px 20px;
  animation: progressShine 2s linear infinite;
}

@keyframes progressShine {
  0% { background-position: -20px 0; }
  100% { background-position: 20px 0; }
}

/* è­¦å‘Šå’ŒæˆåŠŸæç¤ºæ ·å¼å¢å¼º */
.v-alert {
  border-width: 2px;
  border-style: solid;
}

.v-alert--variant-tonal {
  background: linear-gradient(135deg, rgba(var(--v-theme-surface), 0.95) 0%, rgba(var(--v-theme-surface), 0.85) 100%);
  backdrop-filter: blur(10px);
}

/* å¡ç‰‡åŠ¨ä½œåŒºåŸŸæ ·å¼ */
.v-card-actions.bg-grey-lighten-5 {
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.9) 100%) !important;
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(0, 0, 0, 0.08);
}

/* æµ‹è¯•è¯¦æƒ…å¡ç‰‡æ ·å¼ */
.item-stat-card {
  border: 2px solid rgba(0, 0, 0, 0.06);
  border-radius: 12px !important;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
  height: 100%;
}

.item-stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.stat-card-success {
  border-color: rgba(76, 175, 80, 0.3);
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.02) 0%, rgba(255, 255, 255, 0.95) 100%);
}

.stat-card-success:hover {
  border-color: rgba(76, 175, 80, 0.5);
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.15);
}

.stat-card-warning {
  border-color: rgba(255, 152, 0, 0.3);
  background: linear-gradient(135deg, rgba(255, 152, 0, 0.02) 0%, rgba(255, 255, 255, 0.95) 100%);
}

.stat-card-warning:hover {
  border-color: rgba(255, 152, 0, 0.5);
  box-shadow: 0 6px 20px rgba(255, 152, 0, 0.15);
}

.stat-card-error {
  border-color: rgba(244, 67, 54, 0.3);
  background: linear-gradient(135deg, rgba(244, 67, 54, 0.02) 0%, rgba(255, 255, 255, 0.95) 100%);
}

.stat-card-error:hover {
  border-color: rgba(244, 67, 54, 0.5);
  box-shadow: 0 6px 20px rgba(244, 67, 54, 0.15);
}

/* æ¦‚ç‡å¯¹æ¯”å¯è§†åŒ–æ ·å¼ */
.probability-comparison {
  background: rgba(248, 250, 252, 0.5);
  border-radius: 8px;
  padding: 8px;
  margin: 4px 0;
}

/* æµ‹è¯•åˆ†ææç¤ºæ ·å¼ */
.test-analysis-alert {
  border: 2px solid;
  border-radius: 12px !important;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.test-analysis-alert .v-alert__content {
  padding: 16px;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 959px) {
  .item-stat-card {
    margin-bottom: 16px;
  }
}

@media (max-width: 599px) {
  .probability-comparison {
    padding: 6px;
  }
  
  .item-stat-card .v-card-text {
    padding: 12px;
  }
  
  .test-analysis-alert .v-alert__content {
    padding: 12px;
  }
}

/* ç§¯åˆ†é…ç½®å¡ç‰‡æ ·å¼ */
.credits-config-card {
  border: 2px solid rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
  position: relative;
  overflow: hidden;
}

.credits-config-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, 
    rgb(var(--v-theme-warning)) 0%, 
    rgb(var(--v-theme-info)) 100%
  );
  opacity: 0;
  transition: opacity 0.3s ease;
}

.credits-config-card:hover {
  border-color: rgba(255, 152, 0, 0.3);
  box-shadow: 0 4px 16px rgba(255, 152, 0, 0.1);
}

.credits-config-card:hover::before {
  opacity: 1;
}
</style>
